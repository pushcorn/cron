const TZ_TAIPEI = "Asia/Taipei";
const TZ_INDIANAPOLIS = "America/Indianapolis";


test.object ("cron.Expression.FieldGroup")
    .should ("have an expr getter")
        .given (
            nit.new ("cron.fields.DayOfMonth", 3),
            nit.new ("cron.fields.DayOfWeek", 2)
        )
        .expectingPropertyToBe ("result.expr", "3|2")
        .commit ()
;


test.object ("cron.Expression")
    .should ("throw the day of month is invalid")
        .given ("0 0 31 2 *")
        .throws ("error.invalid_day_of_month")
        .commit ()

    .should ("not throw if there is at least one day of month is valid")
        .given ("0 0 28,31 2 *")
        .returnsInstanceOf ("cron.Expression")
        .commit ()

    .should ("accept macro syntax")
        .given ("@hourly")
        .returnsInstanceOf ("cron.Expression")
        .expectingPropertyToBe ("result.second.expr", "0")
        .expectingPropertyToBe ("result.minute.expr", "0")
        .expectingPropertyToBe ("result.hour.expr", "*")
        .expectingPropertyToBe ("result.month.expr", "*")
        .expectingPropertyToBe ("result.dayOfMonth.expr", "*")
        .expectingPropertyToBe ("result.dayOfWeek.expr", "*")
        .commit ()

    .given ("0 0 31 2,3 *")
        .returnsInstanceOf ("cron.Expression")
        .commit ()

    .should ("parse the expression and return an instance of Job")
        .given ("*/10 9-17 * * 1-5", TZ_TAIPEI)
        .returnsInstanceOf ("cron.Expression")
        .expectingPropertyToBe ("result.second.expr", "0")
        .expectingPropertyToBe ("result.minute.expr", "*/10")
        .expectingPropertyToBe ("result.hour.expr", "9-17")
        .expectingPropertyToBe ("result.month.expr", "*")
        .expectingPropertyToBe ("result.dayOfMonth.expr", "*")
        .expectingPropertyToBe ("result.dayOfWeek.expr", "1-5")
        .expectingPropertyToBe ("result.timezone", TZ_TAIPEI)
        .commit ()
;


test.method ("cron.Expression", "next")
    .should ("throw if next occurrence cannot be found")
        .up (s => s.class = s.class.defineSubclass ("Job", true).constant ("MAX_SEARCH_ITERATIONS", 10))
        .up (s => s.createArgs = "0 0 1 1 0")
        .before (s => s.object.getValuesForDate = () => [Math.random ()])
        .throws ("error.unresolvable_expression")
        .commit ()

    .should ("return the next run time")
        .up (s => s.createArgs = "*/10 13-14 * * 1-5")
        .given (nit.parseDate ("2023-09-01 14:50:00"))
        .returnsResultOfExpr ("object")
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-09-04 13:00:00"))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["*/10 9-17 * * 1-5", TZ_TAIPEI])
        .given (new nit.Date ("2023-09-01 18:50:00", TZ_TAIPEI))
        .returnsResultOfExpr ("object")
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-09-04 09:00:00", TZ_TAIPEI))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 1 1 0"])
        .given (new nit.Date ("2024-01-01"))
        .after (s => s.next = s.object.next (s.result.nextRunUtc))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-01-14"))
        .commit ()

    .should ("use the last given date if no value was provided")
        .up (s => s.createArgs = ["0 0 1,15 * Sun"])
        .given (nit.Date ("2023-01-01 01:01:01"))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-01-08"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-01-15"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-01-22"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-01-29"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-02-01"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-02-05"))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 * * Sun"])
        .given (nit.Date ("2023-02-15 01:01:01"))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-02-19"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-02-26"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-05"))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 1,15 * *"])
        .given (nit.Date ("2023-01-01 01:01:01"))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-01-15"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-02-01"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-02-15"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-01"))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-15"))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 1,15 * *", TZ_TAIPEI])
        .given (nit.Date ("2023-01-01 01:01:01", TZ_TAIPEI))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-01-15", TZ_TAIPEI))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-02-01", TZ_TAIPEI))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-02-15", TZ_TAIPEI))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-01", TZ_TAIPEI))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-15", TZ_TAIPEI))
        .commit ()

    .should ("accept an integer timestamp")
        .up (s => s.createArgs = ["0 0 1 1 0"])
        .given (nit.Date ("2024-01-01").getTime ())
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-01-07"))
        .commit ()

    .should ("accept a timestamp string")
        .up (s => s.createArgs = ["0 0 1 1 0"])
        .given ("2024-01-01")
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-01-07"))
        .commit ()

    .should ("be able to handle a different timezone")
        .up (s => s.createArgs = ["*/10 9-17 * * *", TZ_TAIPEI])
        .given (nit.Date ("2023-09-06 22:02:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-09-07 10:10:00", TZ_TAIPEI))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "8 minutes")
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0-3 * * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2023-03-11 23:02:00", TZ_TAIPEI))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-03-12 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "13 hours and 58 minutes")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-12 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-12 03:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-13 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "21 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-13 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-13 02:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-13 03:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .commit ()

    .should ("handle the starting of DST")
        .up (s => s.createArgs = ["0 2 * * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2023-03-12 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-03-12 03:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "2 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-13 02:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "23 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-14 02:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-15 02:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .commit ()

    .should ("handle the starting of DST")
        .up (s => s.createArgs = ["0 0-3 * * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2023-03-12 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-03-12 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-12 03:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-13 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "21 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-13 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-13 02:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-03-13 03:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .commit ()

    .should ("handle the ending of DST")
        .up (s => s.createArgs = ["0 1 * * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2023-11-05 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-11-05 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-06 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day and 1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-07 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-08 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .commit ()

    .should ("handle the ending of DST")
        .up (s => s.createArgs = ["0 0-3 * * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2023-11-05 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-11-05 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-05 02:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "2 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-05 03:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-06 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "21 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-06 01:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-06 02:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-06 03:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 hour")
        .commit ()

    .should ("handle last day of week syntax")
        .up (s => s.createArgs = ["0 0 * * 3L", TZ_INDIANAPOLIS])
        .given (nit.Date ("2023-11-05 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-11-29 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 weeks, 3 days and 1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-12-27 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "4 weeks")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-01-31 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 month and 5 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-02-28 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "4 weeks")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-03-27 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 weeks, 6 days and 23 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-04-24 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "4 weeks")
        .commit ()

    .should ("handle last day of week and range syntax")
        .up (s => s.createArgs = ["0 0 * * 1,2,WedL", TZ_INDIANAPOLIS])
        .given (nit.Date ("2023-11-20 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-11-21 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-27 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "6 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-28 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-11-29 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-12-04 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "5 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-12-05 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-12-11 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "6 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-12-12 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .commit ()

    .should ("handle last day of month syntax")
        .up (s => s.createArgs = ["0 0 L-5 * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2023-11-20 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-11-25 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "5 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2023-12-26 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 month and 1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-01-26 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 month and 1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-02-24 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "4 weeks and 1 day")
        .commit ()

    .should ("handle last day of month syntax")
        .up (s => s.createArgs = ["0 0 L-30 * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2023-11-20 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2023-12-01 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 week and 4 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-01-01 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 month and 1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-03-01 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "2 months")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-05-01 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "2 months and 23 hours")
        .commit ()
;


test.method ("cron.Expression", "next")
    .should ("handle day of month's weekday syntax")
        .up (s => s.createArgs = ["0 0 LW * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2024-02-02 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-02-29 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 weeks and 6 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-03-29 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "4 weeks and 23 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-04-30 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 month and 2 days")
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 LW * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2024-03-02 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-03-29 00:00:00", TZ_INDIANAPOLIS))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 3W * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2024-03-06 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-04-03 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 weeks, 6 days and 23 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-05-03 00:00:00", TZ_INDIANAPOLIS))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 2W * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2024-03-06 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-04-02 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 weeks, 5 days and 23 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-05-02 00:00:00", TZ_INDIANAPOLIS))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 1W * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2024-06-06 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-07-01 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 weeks and 4 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-08-01 00:00:00", TZ_INDIANAPOLIS))
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-09-02 00:00:00", TZ_INDIANAPOLIS))
        .commit ()
;


test.method ("cron.Expression", "next")
    .should ("handle day of week's n-th day of week syntax")
        .up (s => s.createArgs = ["0 0 * * 1#5", TZ_INDIANAPOLIS])
        .given (nit.Date ("2024-08-07 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-09-30 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 month, 3 weeks and 3 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-12-30 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 months, 1 day and 1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2025-03-31 00:00:00", TZ_INDIANAPOLIS))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 * * 6#5", TZ_INDIANAPOLIS])
        .given (nit.Date ("2024-08-07 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-08-31 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 weeks and 3 days")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-11-30 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 months, 1 day and 1 hour")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2025-03-29 00:00:00", TZ_INDIANAPOLIS))
        .commit ()

    .reset ()
        .up (s => s.createArgs = ["0 0 * * 6#5", TZ_INDIANAPOLIS])
        .given (nit.Date ("2025-03-01 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2025-03-29 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "3 weeks, 6 days and 23 hours")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2025-05-31 00:00:00", TZ_INDIANAPOLIS))
        .commit ()
;


test.method ("cron.Expression", "next")
    .should ("handle hash syntax")
        .up (s => s.createArgs = ["H H * * *", TZ_INDIANAPOLIS])
        .given (nit.Date ("2024-08-07 00:00:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("result.nextDate", nit.Date ("2024-08-07 13:06:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "13 hours and 6 minutes")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-08-08 13:06:00", TZ_INDIANAPOLIS))
        .expectingPropertyToBe ("object.timeUntilNextRunHumanized", "1 day")
        .expectingExprToReturnValue ("object.next ().nextDate", nit.Date ("2024-08-09 13:06:00", TZ_INDIANAPOLIS))
        .commit ()
;
